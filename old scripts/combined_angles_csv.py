"""
Скрипт для агрегации и подготовки данных параметров сопоставления изображений.

Назначение:
- Загружает все CSV-файлы из директории 'angles/parameters'
- Извлекает и нормализует структуру данных для обучения модели измерения смещений
- Формирует единый датасет с признаками сопоставления и целевой переменной (угол поворота)
- Сохраняет объединённый датасет в файл 'combined_data_angle.csv'

Структура данных:
- Входные CSV-файлы содержат результаты измерений смещений для разных комбинаций методов сопоставления
- Каждая строка представляет результат сопоставления пары изображений с известным углом поворота
- Признаки организованы по принципу: метод_номер_ось (например, "0_0_dx" = метод 0, изображение 0, смещение по X)

Формат выходного датасета:
- Признаки: 18 столбцов с измеренными смещениями (dx/dy для 9 комбинаций методов)
- Целевая переменная: 'angle' (истинный угол поворота между изображениями)
- Отсутствующие значения заменяются нулями (интерпретируются как нулевое смещение)
"""

import pandas as pd
import os
from pathlib import Path
from sys import path

# ==================== КОНФИГУРАЦИЯ ====================

# Включение обработки бесконечностей как NaN для корректной очистки данных
pd.options.mode.use_inf_as_na = True

# Директория с исходными CSV-файлами параметров
ANGLES_DIR = Path(path[0] + "\\angles\\parameters")

# Структура столбцов во входных файлах:
# - 'angle': истинный угол поворота (градусы) - целевая переменная
# - 'true_dx', 'true_dy': истинные смещения (не используются в текущей задаче)
# - Остальные столбцы: измеренные смещения для разных комбинаций методов сопоставления
#   Формат: "(положение тайла)_ось" (например, "0_0_dx" = строка тайла 0, столбец тайла 0, смещение по X)

# Версия без PCE и response, т.к. они не имеет важности для синтетических данных
# columns = [
#     "0_0_dx", "0_0_dy", "0_1_dx", "0_1_dy", "0_2_dx", "0_2_dy",
#     "1_0_dx", "1_0_dy", "1_1_dx", "1_1_dy", "1_2_dx", "1_2_dy",
#     "2_0_dx", "2_0_dy", "2_1_dx", "2_1_dy", "2_2_dx", "2_2_dy",
#     "angle"
# ]

columns = [
            "0_0_dx", "0_0_dy", "0_0_PCE", "0_0_resp", "0_1_dx", "0_1_dy", "0_1_PCE", "0_1_resp", "0_2_dx", "0_2_dy", "0_2_PCE", "0_2_resp",
            "1_0_dx", "1_0_dy", "1_0_PCE", "1_0_resp", "1_1_dx", "1_1_dy", "1_1_PCE", "1_1_resp", "1_2_dx", "1_2_dy", "1_2_PCE", "1_2_resp",
            "2_0_dx", "2_0_dy", "2_0_PCE", "2_0_resp", "2_1_dx", "2_1_dy", "2_1_PCE", "2_1_resp", "2_2_dx", "2_2_dy", "2_2_PCE", "2_2_resp",
            "angle"
]

# ==================== ОБРАБОТКА ДАННЫХ ====================

# Список для хранения обработанных датафреймов из каждого файла
dataframes = []

# Итерация по всем файлам в директории параметров
for file in os.listdir(ANGLES_DIR):
    # Обработка только CSV-файлов
    if file.endswith('.csv'):  
        file_path = ANGLES_DIR / file
        
        try:
            # Загрузка CSV-файла с указанием кодировки (защита от ошибок чтения)
            df = pd.read_csv(file_path, encoding='utf-8')
            
            # Проверка наличия всех необходимых столбцов
            missing_cols = set(columns) - set(df.columns)
            if missing_cols:
                print(f"Пропущен файл {file}: отсутствуют столбцы {missing_cols}")
                continue
            
            # Извлечение только необходимых столбцов в заданном порядке
            df_features = df.loc[:, columns].copy()
            
            # Добавление обработанного датафрейма в список
            dataframes.append(df_features)
            print(f"Обработан файл: {file} ({len(df_features)} строк)")
            
        except Exception as e:
            print(f"Ошибка обработки файла {file}: {str(e)}")
            continue

# ==================== АГРЕГАЦИЯ И СОХРАНЕНИЕ ====================

# Объединение всех датафреймов в единый набор данных
if dataframes:
    # Сброс индексов для корректной нумерации строк в объединённом датасете
    all_data = pd.concat(dataframes, ignore_index=True)
    print(f"\nОбъединено {len(dataframes)} файлов → итого {len(all_data)} строк данных")
else:
    # Создание пустого датафрейма с правильной структурой при отсутствии данных
    all_data = pd.DataFrame(columns=[col for col in columns])
    print("Не найдено валидных CSV-файлов для обработки")

# Обработка пропущенных значений
all_data.fillna(0, inplace=True)

# Вывод сводной информации о датасете
print(f"\nПример данных:")
print(all_data.head(3))

# Сохранение объединённого датасета в файл
csv_path = Path(path[0] + "\\angles\\combined_data_angle.csv")
all_data.to_csv(csv_path, index=False, encoding='utf-8')
print(f"\nДатасет сохранён: {csv_path}")
print(f"Размер файла: {os.path.getsize(csv_path) / 1024:.1f} КБ")